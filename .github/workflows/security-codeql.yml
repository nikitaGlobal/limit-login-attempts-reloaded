name: Security - CodeQL

# AI: Run CodeQL security analysis for PHP in GitHub Actions.
on:
  push:
    paths:
      - "**/*.php"
      - ".github/workflows/security-codeql.yml"
  pull_request:
    paths:
      - "**/*.php"
      - ".github/workflows/security-codeql.yml"
  workflow_dispatch:

# AI: Minimal permissions required for CodeQL scanning and SARIF upload.
permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: CodeQL analyze (PHP)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Initialize CodeQL
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: github/codeql-action/init@45580472a5bb82c4681c4ac726cfdb60060c2ee1
        with:
          languages: php

      - name: Perform CodeQL analysis (trusted events)
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: github/codeql-action/analyze@45580472a5bb82c4681c4ac726cfdb60060c2ee1

      - name: Perform CodeQL analysis (fork PR, no upload)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        # AI: Avoid upload attempts when fork PR token has restricted write scope.
        uses: github/codeql-action/analyze@45580472a5bb82c4681c4ac726cfdb60060c2ee1
        with:
          upload: false
