name: Security - Semgrep CE

# AI: Run security checks on every commit, PR, and manual GitHub run.
on:
  push:
  pull_request:
  workflow_dispatch:

# AI: Minimal permissions for public-repo safety; no write to code.
permissions:
  contents: read
  security-events: write

jobs:
  semgrep:
    name: Semgrep CE scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          # AI: Shallow clone is enough for this scan and limits exposure.
          fetch-depth: 1

      - name: Set up Python
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"

      - name: Install Semgrep CE
        run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep CE
        # AI: Keep output concise and disable telemetry in public CI.
        run: semgrep scan --config p/security-audit --config p/secrets --metrics=off --quiet --sarif --output semgrep.sarif --error

      - name: Upload Semgrep SARIF
        # AI: Skip SARIF upload for fork PRs where write access is restricted.
        if: always() && hashFiles('semgrep.sarif') != '' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        # AI: Pin action to a commit SHA to reduce supply-chain drift risk.
        uses: github/codeql-action/upload-sarif@45580472a5bb82c4681c4ac726cfdb60060c2ee1
        with:
          sarif_file: semgrep.sarif
